description: >
  "Collect data from this job and report to SumoLogic. Note: MUST BE LAST COMMAND IN JOB."
parameters:
  circle-token:
    type: env_var_name
    default: "CIRCLE_TOKEN"
    description: |
      "The environment variable name containing your CircleCI Personal API token.
      The API token is used to fetch additional analytics not present within the container.
      Generate yours here: https://circleci.com/account/api"
  http-source:
      type: string
      default: "https://endpoint5.collection.us2.sumologic.com/receiver/v1/http/ZaVnC4dhaV1VCdep0Zx0KEmNJoaotZ0BVR_LCX0meGyJPGPnHAA0IALBdhwDeeBZwKQj1mXGcPuTGNchCiqRrZ0ZVS4opkcs2neidpCh0-BKO3jg9IH8kg=="
      description: "Enter the HTTP Source endpoint generated by the Sumologic setup wizard."
steps:
  - run:
      name: SumoLogic Job Collector
      when: always
      command: |
        # Get required Env Vars
        VCS_TYPE=$( echo $CIRCLE_BUILD_URL | cut -d'/' -f4)
        ORG_NAME=$( echo $CIRCLE_BUILD_URL | cut -d'/' -f5)
        PROJECT_NAME=$( echo $CIRCLE_BUILD_URL | cut -d'/' -f6)
        # Fetch job data from API
        SL_PAYLOAD=$(curl https://circleci.com/api/v1.1/project/$VCS_TYPE/$ORG_NAME/$PROJECT_NAME/$CIRCLE_BUILD_NUM?circle-token=$<< parameters.circle-token >>)
        # Pre-Process data here if needed.
        # Write data to /tmp/sumologic-logs/job-colloector.json
        echo $SL_PAYLOAD > /tmp/sumologic-logs/job-colloector.json
        # Send data to SumoLogic
        curl -v -X POST -T /tmp/sumologic-logs/job-colloector.json -H 'Content-Encoding:gzip' << parameters.http-source >>

