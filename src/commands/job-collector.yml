description: >
  "Collect data from this job and report to SumoLogic. Note: MUST BE LAST COMMAND IN JOB."
parameters:
  circle-token:
    type: env_var_name
    default: "CIRCLE_TOKEN"
    description: |
      "The environment variable name containing your CircleCI Personal API token.
      The API token is used to fetch additional analytics not present within the container.
      Generate yours here: https://circleci.com/account/api"
  http-source:
      type: env_var_name
      default: "HTTP_SOURCE"
      description: "Enter the HTTP Source endpoint generated by the Sumologic setup wizard."
steps:
  - jq/install
  - run:
      name: SumoLogic Job Collector
      when: always
      command: |
        # Fetch job data from API
        WF_PAYLOAD=$(curl https://circleci.com/api/v2/workflow/$CIRCLE_WORKFLOW_ID/jobs?circle-token=$<< parameters.circle-token >>)
        # Pre-Process data here if needed.
        WORKFLOWLENGTH=$(echo "$WF_PAYLOAD" | jq length)
        echo "WF length $WORKFLOWLENGTH"
        #fetch job data for only this job.
        WF_LOOP="0"
        echo "Searching for job data"
        while [ "$WF_LOOP" -lt "$WORKFLOWLENGTH" ];
        do
          echo "loop $WF_LOOP"
          JOBDATA=$(echo "$WF_PAYLOAD" | jq ".[][$WF_LOOP]")
          echo
          echo "job data: "
          echo "$JOBDATA"
          echo
          echo "Checking Job Number"
          JOBNUMBER=$(echo "$JOBDATA" | jq '.job_number')
          echo
          echo "job number $JOBNUMBER"
          echo "internal job number: $CIRCLE_BUILD_NUM"
          echo "Checking if equal"
          if [ "$JOBNUMBER" = "$CIRCLE_BUILD_NUM" ];
          then
            echo "this is the correct job"
            break
          fi
          echo "Trying next job in workflow. Data was not in $WF_LOOP"
          WF_LOOP=$[$WF_LOOP +1]
        done
        # Write data to /tmp/sumologic-logs/job-colloector.json
        mkdir -p /tmp/sumologic-logs/
        if [ -z $JOBDATA ];
        then
          echo "$JOBDATA" > /tmp/sumologic-logs/job-colloector.json
          # Send data to SumoLogic
          curl -v -X POST -T /tmp/sumologic-logs/job-colloector.json $<< parameters.http-source >>
        else
          echo "Error: Job data was not found. Please consider opening an issue https://circleci.com/gh/CircleCI-Public/sumologic-orb"
        fi
